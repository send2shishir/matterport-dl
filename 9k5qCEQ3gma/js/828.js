(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[828],{28497:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BatchToggleBlurVisibilityCommand:()=>BatchToggleBlurVisibilityCommand,BlurToolChangeCommand:()=>BlurToolChangeCommand,BlurToolState:()=>i,HideBlursCommand:()=>HideBlursCommand,NavigateToBlurCommand:()=>NavigateToBlurCommand,SetBlurBrushScaleCommand:()=>SetBlurBrushScaleCommand,ShowBlursCommand:()=>ShowBlursCommand,ToggleBlurVisibilityCommand:()=>ToggleBlurVisibilityCommand,default:()=>BlurEditorModule});var i,n=s(19663);class BlurToolChangeCommand extends n.m{constructor(e){super(),this.id="BLUR_TOOL_CHANGE",this.payload={state:e}}}class SetBlurBrushScaleCommand extends n.m{constructor(e){super(),this.id="SET_BLUR_BRUSH_SCALE",this.payload={scale:e}}}class NavigateToBlurCommand extends n.m{constructor(e,t=!1){super(),this.id="NAVIGATE_TO_BLUR",this.payload={blur:e,resetBlurTool:t}}}class ToggleBlurVisibilityCommand extends n.m{constructor(e){super(),this.id="TOGGLE_BLUR_VISIBILITY",this.payload={id:e}}}class ShowBlursCommand extends n.m{constructor(...e){super(),this.id="SHOW_BLURS",this.payload={ids:e}}}class HideBlursCommand extends n.m{constructor(...e){super(),this.id="HIDE_BLURS",this.payload={ids:e}}}class BatchToggleBlurVisibilityCommand extends n.m{constructor(e){super(),this.id="BATCH_TOGGLE_BLUR_VISIBILITY",this.payload={ids:e}}}!function(e){e.OFF="off",e.IDLE="idle",e.PAINTING="painting",e.SUGGESTING="suggesting"}(i||(i={}));var a,r=s(84428),o=s(97542),l=s(57956),u=s(35895),d=s(53954),c=s(86819),h=s(67678),m=s(89553),g=s(66222),p=s(98333),b=s(13117),f=s(66310),S=s(47994),v=s(38987),B=s(34956),C=s(85992),E=s(23254),w=s(95882),y=s(12039),T=s(64918),x=s(90304),I=s(2569),D=s(76631),_=s(89549),R=s(40964),P=s(91380),O=s(50892),N=s(17878),A=s(12529),k=s(49827),L=s(97998),M=s(80592),G=s(59370),U=s(92826),j=s(89570),V=s(37082);!function(e){e.DISABLED="disabled",e.IDLE="idle",e.PAINTING="painting"}(a||(a={}));class SphereBrushCursor extends r.Object3D{constructor(){super(),this._radius=.1,this._thickness=.005,this.name="SphereBrushCursor";const e=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,depthTest:!1,transparent:!0}),t=this.getGeometry();this.mesh=new r.Mesh(t,e),this.mesh.renderOrder=A.z.reticule,this.add(this.mesh)}getGeometry(){return new r.RingGeometry(this._radius,this._radius+this._thickness,64)}updateCursorMesh(){this.mesh.geometry.dispose(),this.mesh.geometry=this.getGeometry()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateCursorMesh()}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose()}}const F=new L.Z("pano-brush");class PanoBrush{constructor(e,t,s,i,n=N.o.ALL){this.sweepData=e,this.cameraData=t,this.scene=s,this.input=i,this.cameraVector=new r.Vector3,this.lastPaint=new r.Vector3,this.mouseCursorEnabled=!1,this.needsUpdate=!0,this.observables={size:new V.f(.1),scale:new V.f(.2),feather:new V.f(.1),pressure:new V.f(.1),opacity:new V.f(1),state:new V.f(a.DISABLED)},this.position=new r.Vector3,this.direction=new r.Vector3,this.sizeRange=[.1,.5],this.featherRange=[.005,.125],this.pressureRange=[.0063,.0125],this.onPointerButton=e=>e.down?this.startPainting():this.stopPainting(),this.onPointerMove=e=>{const t=(0,G.st)(this.cameraData,e.position);if(this.setPosition(t),this.state===a.PAINTING&&this.onPaint){const e=(0,I.et)(this.observables.size.value,this.sizeRange[0],this.sizeRange[1],.005,.03);if(this.lastPaint.length()>0){const t=this.direction.clone().sub(this.lastPaint).setLength(e),s=this.lastPaint.clone();for(;s.angleTo(this.direction)>e;)s.add(t).normalize(),this.lastPaint.copy(s),this.onPaint(s,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}else this.lastPaint.copy(this.direction),this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}},this.onClick=e=>{const t=(0,G.st)(this.cameraData,e.position);this.setPosition(t),this.onPaint&&this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)},this.onMouseMove=e=>{const{tagName:t}=e.target||{},s=this.mouseCursorEnabled||!t||"CANVAS"!==t?null:B.C.NONE;s!==this.mouseCursor&&(this.engine.commandBinder.issueCommand(new v.u(s)),this.mouseCursor=s)},this.brushCursor=new SphereBrushCursor,this.brushCursor.renderOrder=A.z.reticule,this.brushCursor.layers.mask=n.mask}init(){this.bindings=new j.V(this.input.registerPriorityHandler(M._t,r.Mesh,(()=>!0)),this.input.registerHandler(h.mE,this.onPointerMove),this.input.registerHandler(h.er,this.onPointerButton),this.input.registerUnfilteredHandler(c.R,this.onClick),new U.r(document.body,"mousemove",this.onMouseMove)),this.bindings.cancel()}render(){this.state!==a.DISABLED&&this.needsUpdate&&(this.brushCursor.position.copy(this.position),this.brushCursor.lookAt(this.scene.camera.getWorldPosition(this.cameraVector)),this.needsUpdate=!1)}dispose(){this.brushCursor.dispose()}activate(e){this.engine=e}deactivate(e){this.disable()}enable(){F.debug("Enabled"),this.observables.state.value=a.IDLE,this.bindings.renew(),this.scene.add(this.brushCursor)}disable(){F.debug("Disabled"),this.observables.state.value=a.DISABLED,this.bindings.cancel(),this.scene.remove(this.brushCursor),this.engine.commandBinder.issueCommand(new v.u(null))}onPropertyChanged(e,t){return this.observables[e].onChanged(t)}getSizeRange(){return this.sizeRange}setSizeRange(e,t){this.sizeRange=[e,t],this.scale=this.observables.scale.value}get scale(){return this.observables.scale.value}set scale(e){const t=(0,k.uZ)(e,0,1),s=(0,I.dS)(t,0,1,this.sizeRange[0],this.sizeRange[1]),i=(0,I.dS)(t,0,1,this.featherRange[0],this.featherRange[1]),n=(0,I.dS)(t,0,1,this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=s,this.observables.size.value=s,this.observables.scale.value=t,this.observables.feather.value=i,this.observables.pressure.value=n,F.debug(`Set brush scale to ${100*t}% (${s})`)}get state(){return this.observables.state.value}get size(){return this.observables.size.value}set size(e){const t=(0,k.uZ)(e,this.sizeRange[0],this.sizeRange[1]),s=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],0,1),i=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],this.featherRange[0],this.featherRange[1]),n=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=t,this.observables.size.value=t,this.observables.scale.value=s,this.observables.feather.value=i,this.observables.pressure.value=n,F.debug(`Set brush size to ${t} (${100*s}%)`)}toggleMouseCursor(e){this.mouseCursorEnabled=e}startPainting(){this.observables.state.value=a.PAINTING}stopPainting(){this.observables.state.value=a.IDLE,this.lastPaint.set(0,0,0)}setPosition(e){const t=this.sweepData.currentSweepObject;if(!t)return;const s=e.clone().sub(t.position).normalize(),i=t.position.clone().add(s);this.position.copy(i),this.direction.copy(s),this.needsUpdate=!0}}class BlurMesh extends r.InstancedMesh{}var z=s(947),H=s(58611),Q=s(41187),W=s(18923);const Y={brush:{uniforms:{opacity:{type:"v3",value:new r.Vector3(1,1,1)},color:{type:"c",value:new r.Color},radius:{type:"v3",value:new r.Vector3(.1,.1,.1)},feather:{type:"v3",value:new r.Vector3(0,0,0)}},vertexShader:s(59285),fragmentShader:s(65794)},combineBlurs:{uniforms:{maskMatrix:{type:"m4",value:new r.Matrix4},maskTexture:{type:"t",value:null},panoMatrix1:{type:"m4",value:new r.Matrix4},panoMatrix2:{type:"m4",value:new r.Matrix4},panoBlurredMap0:{type:"t",value:null},panoBlurredMap1:{type:"t",value:null},panoBlurredMap2:{type:"t",value:null},panoBlurredMap3:{type:"t",value:null}},vertexShader:s(77288),fragmentShader:s(34468)}};var $=s(36074);const q=new r.Matrix4;function Z(e){const t=new r.WebGLCubeRenderTarget(e,{format:r.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1});return t.texture.image={},t.texture.image.width=e,t.texture.image.height=e,t}class BlurRenderTarget{constructor(e,t,s){this.inputSize=e,this.outputSize=t,this.sigma=s,this.input=Z(e),this.output=Z(t)}get texture(){return this.output.texture}}class BlurOverlayRenderer{constructor(e,t){this.renderToTexture=e,this.renderer=t,this.renderTarget=new r.WebGLCubeRenderTarget(2048,{format:r.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1}),this.camera=new r.Camera,this.blurRTs=$.TW.map((e=>((e,t,s)=>{const i=new BlurRenderTarget(e,t,s);return{renderTarget:i,cubeCamera:new r.CubeCamera(.1,1e3,i.output)}})(e.size,2*e.size,e.sigma))),this.debug={};const s=r.UniformsUtils.clone(Y.combineBlurs.uniforms);this.material=new r.RawShaderMaterial({fragmentShader:Y.combineBlurs.fragmentShader,vertexShader:Y.combineBlurs.vertexShader,uniforms:s,side:r.DoubleSide,name:"CubemapRendererMaterial"}),this.mesh=new r.Mesh(new r.BoxBufferGeometry(100,100,100),this.material),this.material.uniforms.panoBlurredMap0.value=this.blurRTs[0].renderTarget.texture,this.material.uniforms.panoBlurredMap1.value=this.blurRTs[1].renderTarget.texture,this.material.uniforms.panoBlurredMap2.value=this.blurRTs[2].renderTarget.texture,this.material.uniforms.panoBlurredMap3.value=this.blurRTs[3].renderTarget.texture,this.renderTarget.texture.image={},this.renderTarget.texture.image.height=2048,this.renderTarget.texture.image.width=2048}setDebug(e,t){t?this.debug[e]=!0:this.debug[e]&&delete this.debug[e],this.material.defines=this.debug,this.material.needsUpdate=!0,this.render()}render(){this.renderToTexture.render(this.renderTarget,this.mesh,this.camera)}get texture(){return this.renderTarget.texture}setMaskTexture(e,t=q){this.material.uniforms.maskTexture.value=e,this.material.uniforms.maskMatrix.value.copy(t)}setPano(e,t,s=q,i=q){if(e!==this.currentSweepId||this.currentPanoTexture!==t){this.currentSweepId=e,this.currentPanoTexture=t;for(const e of this.blurRTs){const s=e.renderTarget,i=.5/s.input.width;this.renderer.copyCubemap(t,s.input),this.renderer.blurCubemap(s.input.texture,e.cubeCamera,s.sigma,i)}this.material.uniforms.panoMatrix1.value.copy(s),this.material.uniforms.panoMatrix2.value.copy(i)}}reset(){this.currentSweepId=null,this.currentPanoTexture=null}}class BrushMaterial extends r.RawShaderMaterial{constructor(e,t,s,i){const n=r.UniformsUtils.clone(Y.brush.uniforms);n.radius.value.copy(e),n.feather.value.copy(t),n.opacity.value.copy(s),n.color.value.set(1,0,0),super(Object.assign(Object.assign({},i),{fragmentShader:Y.brush.fragmentShader,vertexShader:Y.brush.vertexShader,uniforms:n,side:r.FrontSide,transparent:!0,blending:r.AdditiveBlending,name:"brushMaterial"}))}get color(){return this.uniforms.color.value}set color(e){this.uniforms.color.value=e}}var K=s(56512),J=s(92901);const X=new r.Color(16711680),ee=new r.Color(65280),te=new r.Color(255);class BlurRenderer{constructor(e,t,s,i,n,a,o){this.sweepData=e,this.blurEditorData=t,this.scene=s,this.input=i,this.panoRenderer=o,this.root=new r.Group,this.meshes={},this.maskRenderTarget=new r.WebGLCubeRenderTarget(1024,{format:r.RGBAFormat,generateMipmaps:!1}),this.maskCamera=new r.Camera,this.maskBackground=new r.Mesh(new r.BoxGeometry(10,10,10),new r.MeshBasicMaterial({color:0,side:r.DoubleSide})),this.maskVisible=!1,this.dirty=!0,this.updating=!1,this.bindings=[],this.blurs=[],this.renderBlurredOverlay=(()=>{const e=new r.Matrix4,t=new r.Matrix4,s=new r.Quaternion;return async i=>{this.maskCamera.position.copy(i.position),this.maskBackground.position.copy(i.position),await this.engine.commandBinder.issueCommand(new Q.sp(this.maskRenderTarget,this.root,this.maskCamera));const n=this.maskRenderTarget.texture,a=this.panoRenderer.useTexture(i.id);e.makeRotationFromQuaternion(s.copy(i.rotation).invert()),t.makeScale(-1,1,1),this.overlayRenderer.setPano(i.id,a,e,t),this.overlayRenderer.setMaskTexture(n),this.overlayRenderer.render(),this.panoRenderer.freeTexture(i.id),await this.engine.after(z.A.Begin),await this.engine.commandBinder.issueCommand(new H.M(i.id,this.overlayRenderer.texture,new r.Quaternion))}})(),this.currentSweep=this.sweepData.currentSweepObject||null,this.overlayRenderer=new BlurOverlayRenderer(n,a)}setBlurs(e){this.blurs!==e&&(this.blurs=e,this.dirty=!0)}init(){this.root.add(this.maskBackground)}async activate(e){const[t]=await Promise.all([e.getModuleBySymbol(l.y.SETTINGS)]);this.engine=e,this.meshes={},this.bindings.push(this.blurEditorData.onChanged((()=>this.dirty=!0)),e.subscribe(W.Z,(e=>{this.currentSweep=this.sweepData.getSweep(e.toSweep),this.dirty=!0})),e.subscribe(J.Xq,(()=>{this.overlayRenderer.reset(),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)}))),t.registerButton("Blur Debug","Toggle blur level coloration",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_COLORS",!this.overlayRenderer.debug.DEBUG_BLUR_COLORS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),t.registerButton("Blur Debug","Toggle blur test",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_LEVELS",!this.overlayRenderer.debug.DEBUG_BLUR_LEVELS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),this.maskRenderTarget.texture.image={},this.maskRenderTarget.texture.image.width=1024,this.maskRenderTarget.texture.image.height=1024}dispose(){this.root.traverse((e=>{e instanceof r.Mesh&&e.geometry.dispose()}))}render(){this.dirty&&!this.updating&&(this.updating=!0,this.dirty=!1,this.update().finally((()=>{this.updating=!1})))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}getBlursForSweep(e){return this.blurs.filter((t=>t.sweepId===e))}async update(){var e,t;if(!this.currentSweep)return;const s=this.currentSweep,n=this.getBlursForSweep(s.id),a={};for(const e of n)for(const[t,s]of e.dots.entries())a[`${e.id}-${t}`]=s;let o=!1;for(const e in this.meshes){const t=this.meshes[e];a[e]&&a[e].directions.length===t.count||(this.root.remove(t),this.input.unregisterMesh(t),delete this.meshes[e],o=!0)}const l=new r.Vector3,u=new r.Vector3,d=new r.Vector3,c=new r.Matrix4,h=new r.Vector3;for(const e of n)for(const[t,i]of e.dots.entries()){const n=`${e.id}-${t}`;if(0===i.directions.length||this.meshes[n])continue;l.set(i.radius,i.radius-i.feather,i.radius),u.set(i.feather,i.feather,i.feather),d.set(i.strength,1,i.strength);const a=new BrushMaterial(l,u,d,{defines:{USE_INSTANCING:!0},depthTest:!1,depthWrite:!1}),r=new BlurMesh((0,K.fc)(),a,i.directions.length);r.blurId=e.id,i.directions.forEach(((e,t)=>{const n=2*(i.radius+i.feather),a=se(e,s);c.lookAt(s.position,a,x.f.UP),c.scale(h.set(n,n,n)),c.setPosition(a),r.setMatrixAt(t,c)})),this.meshes[n]=r,this.root.add(r),this.input.registerMesh(r,!1),o=!0}const m=new r.Color,{toolState:g,selectedBlur:p,hoveredBlur:b}=this.blurEditorData;for(const s in this.meshes){const n=this.meshes[s],a=n.material;m.copy(X);let r=A.z.reticule+.1;const l=null===(e=null==b?void 0:b.editable)||void 0===e||e,u=null===(t=null==p?void 0:p.editable)||void 0===t||t;g!==i.PAINTING&&(l&&n.blurId===(null==b?void 0:b.id)&&(m.add(te),r=A.z.reticule+.2),u&&n.blurId===(null==p?void 0:p.id)&&(m.add(ee),r=A.z.reticule+.3)),a.color.equals(m)&&n.renderOrder===r||(a.color.copy(m),n.renderOrder=r,o=!0)}o&&await this.renderBlurredOverlay(s)}setMaskVisibility(e){this.maskVisible!==e&&(e?this.scene.add(this.root):this.scene.remove(this.root),this.maskVisible=e)}}function se(e,t){const s=e.clone().applyQuaternion(t.rotation).normalize();return t.position.clone().add(s)}var ie=s(67992),ne=s(75287),ae=s(15637);class BlurEditorState extends ne.T{constructor(){super(...arguments),this.selected=!1,this.hovered=!1}}class BlurEditorInteractions extends ne.T{constructor(){super(...arguments),this.openedTool=!1,this.createdBlur=!1}}class BlurEditorData extends ie.V{constructor(){super(...arguments),this.name="blur-editor",this.toolState=i.IDLE,this.brushCursorVisibility=!1,this.interactions=new BlurEditorInteractions,this.showMouseCursor=!1,this.states=new ae.v,this._selectedBlur=null,this._hoveredBlur=null}getState(e){let t=this.states.get(e);return t||(t=new BlurEditorState,this.states.set(e,t)),t}get selectedBlur(){return this._selectedBlur}set selectedBlur(e){if(this.selectedBlur===e)return;const t=this.selectedBlur;if(this._selectedBlur=e,this.commit(),e){const t=this.getState(e.id);t.selected=!0,t.commit()}if(t){const e=this.getState(t.id);e.selected=!1,e.commit()}}onSelectedBlurChanged(e){return this.onPropertyChanged("_selectedBlur",e)}get hoveredBlur(){return this._hoveredBlur}set hoveredBlur(e){if(this.hoveredBlur===e)return;const t=this.hoveredBlur;if(this._hoveredBlur=e,this.commit(),e){const t=this.getState(e.id);t.hovered=!0,t.commit()}if(t){const e=this.getState(t.id);e.hovered=!1,e.commit()}}onHoveredBlurChanged(e){return this.onPropertyChanged("_hoveredBlur",e)}}var re=s(45325),oe=s(70459),le=s(44109),ue=s(60975),de=s(19077),ce=s(79727),he=s(23037),me=s(38399),ge=s(71776),pe=s(39693),be=s(43736),fe=s(92001),Se=s(21973),ve=s(41326),Be=s(80361),Ce=s(22645),Ee=s(91443),we=s(17176),ye=s(92290),Te=s(85893),xe=s(66102),Ie=s(94005);const{BLURS:De,SCANS:_e,MODAL:Re}=me.Z.WORKSHOP;function Pe({sweepCount:e,blurCount:t,failedBlurCount:s,nudge:i}){const n=(0,xe.b)(),a=n.t(_e.NUM_TYPE,e),r=n.t(De.NUM_TYPE,t),o=n.t(De.APPLY_MODAL_MESSAGE,{scans:a,blurs:r}),l=n.t(De.APPLY_MODAL_WARNING),u=n.t(De.APPLY_MODAL_NUDGE_MESSAGE);let d;s>0&&(d=n.t(De.APPLY_MODAL_RETRY));const c=t>$.Dr&&n.t(De.APPLY_MODAL_TRUNCATED,{blurs:r,maxBlurs:$.Dr});return(0,Te.jsxs)("div",{children:[i&&(0,Te.jsx)("p",{children:u}),(0,Te.jsx)("p",{dangerouslySetInnerHTML:{__html:o}}),(0,Te.jsx)("p",{dangerouslySetInnerHTML:{__html:l}}),d&&(0,Te.jsx)("p",{dangerouslySetInnerHTML:{__html:d}}),c&&(0,Te.jsx)("p",{dangerouslySetInnerHTML:{__html:c}})]})}const Oe=async(e,t,s)=>{if(!e.hasUnappliedBlurs())return!1;const i=e.getByStatus(f.Q.PENDING,f.Q.FAILED),n=e.getByStatus(f.Q.FAILED),a=new Set(i.map((e=>e.sweepId))),r=s?De.APPLY_MODAL_NUDGE_TITLE:De.APPLY_MODAL_TITLE,o=s?De.APPLY_MODAL_NUDGE_CANCEL:Re.NO,l={title:r,message:(0,Te.jsx)(Pe,{sweepCount:a.size,blurCount:i.length,failedBlurCount:n.length,nudge:s}),cancellable:!0,confirmPhraseKey:De.APPLY_MODAL_CONFIRM,cancelPhraseKey:o,cancelVariant:s?Ie.Wu.TERTIARY:Ie.Wu.SECONDARY,modalClass:"blur-tool-modal"};return await t.issueCommand(new ye.EW(ye.Rx.DISPLAY,l))===ye.Uc.CONFIRM},{SUGGESTIONS:Ne}=me.Z.WORKSHOP;class BlurToolManager{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[fe.U]:!1,[ge.re]:!1,[pe.Mp]:!1,[he.Nj]:!1,[be.s]:!1},this.navigateToNextSuggestion=(e,t)=>{let s;for(let i=0;i<e.length;i++){const n=e[i],a=n.items.indexOf(t);if(-1!==a){const t=a+1;t<n.items.length?s=n.items[t]:e[i+1]&&e[i+1].items.length&&(s=e[i+1].items[0]);break}}s&&this.engine.commandBinder.issueCommand(new NavigateToBlurCommand(s,!1))},this.debouncedNavigateToNextSuggestion=(0,Be.D)(this.navigateToNextSuggestion,500),this.settingsToggler=new ue.u(this.settingsData,this.toggledAssets)}async activate(){var e;if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,i,n,a]=await Promise.all([e.waitForData(b.f),e.waitForData(BlurEditorData),e.waitForData(ce.c),e.waitForData(Se.D),e.waitForData(E.O)]),r=new de.Q(t.blurs);r.sort(((e,t)=>e.index-t.index)),r.priority=de.K.LOW;const o=await e.waitForData(Ce.a),l=new de.Q(o.suggestions);l.setFilter("accepted",(e=>null===e.accepted)),l.sort(((e,t)=>t.index-e.index)),this.dataMap={blurData:t,blurEditorData:s,blurList:r,floorsViewData:i,settings:this.settingsData,suggestionData:o,suggestionList:l,sweepViewData:n,viewmodeData:a}}const t=null===(e=this.dataMap.sweepViewData.data.currentSweepObject)||void 0===e?void 0:e.isAligned(),s=this.dataMap.viewmodeData.canStartTransition()&&this.dataMap.viewmodeData.currentMode!==w.Ey.Panorama;s&&!t&&await this.engine.commandBinder.issueCommand(new ve._i(ve.BD.INSIDE)),this.settingsToggler.toggle(!0),this.toggleBlurTool(i.IDLE),s&&t&&await this.engine.commandBinder.issueCommand(new ve._i(ve.BD.INSIDE))}async deactivate(){const{blurData:e}=this.dataMap;if(!e.hasProcessingBlurs()&&e.hasUnappliedBlurs()){await Oe(this.dataMap.blurData,this.engine.commandBinder,!0)&&this.engine.commandBinder.issueCommand(new g.Mh)}this.settingsToggler.toggle(!1),await this.toggleBlurTool(i.OFF)}async hasPendingEdits(){return this.dataMap.blurEditorData.toolState===i.PAINTING}async toggleBlurTool(e){await this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(e))}async rejectAllSuggestions(){const{suggestionData:e}=this.dataMap;if(!e)return!1;const t=e.getByAccepted(null).map((e=>e.id));if(!t.length)return!1;const s=(0,we.P)(t.length,Ne.TYPE);return await this.engine.commandBinder.issueCommand(new ye.EW(ye.Rx.DISPLAY,s))!==ye.Uc.CLOSE&&(this.engine.commandBinder.issueCommand(new Ee.oA(...t)),!0)}}var Ae=s(67294),ke=s(61068),Le=s(94184),Me=s.n(Le),Ge=s(33558),Ue=s(38772),je=s(16507),Ve=s(25328),Fe=s(3773);class ActionBar extends Ae.Component{addChildClasses(e){return!!e&&(0,Ae.cloneElement)(e,{className:`action-bar-item ${e.props.className||""}`})}render(){const{children:e}=this.props;return(0,Te.jsx)("div",Object.assign({className:"action-bar"},{children:Ae.Children.map(e,this.addChildClasses)}))}}var ze,He=s(31362);!function(e){e.size="size",e.scale="scale",e.feather="feather",e.pressure="pressure",e.opacity="opacity",e.state="state"}(ze||(ze={}));var Qe=function(e,t,s,i){var n,a=arguments.length,r=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(r=(a<3?n(r):a>3?n(t,s,r):n(t,s))||r);return a>3&&r&&Object.defineProperty(t,s,r),r};const{BLURS:We}=me.Z.WORKSHOP;var Ye;!function(e){e.CREATE="create",e.BRUSH_SIZE="brushsize"}(Ye||(Ye={}));let $e=class BlurActionBar extends Ae.Component{constructor(e){super(e),this.bindings=[],this.onToolStateChange=e=>{let{creating:t}=this.state;e===i.IDLE?t=!1:e===i.PAINTING&&(t=!0),this.setState({toolState:e,creating:t})},this.onBrushStateChange=e=>{this.setState({brushState:e})},this.onSelectedBlurChange=e=>{this.setState({selectedBlur:e})},this.onBrushSizeChange=e=>{const t=Math.round((0,I.et)(e,0,1,1,100));this.setState({brushSize:t})},this.onBrushSizeSliderChange=e=>{const{commandBinder:t}=this.context;this.dismissTooltip(Ye.BRUSH_SIZE);const s=(0,I.et)(e,1,100,0,1);t.issueCommand(new SetBlurBrushScaleCommand(s))},this.onDeleteClick=async()=>{const{toolState:e}=this.state;await this.deleteSelectedBlur(),e===i.PAINTING&&this.context.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE))},this.onCreateClick=()=>{this.dismissTooltip(Ye.CREATE);let e=i.IDLE;this.state.toolState===i.IDLE&&(e=i.PAINTING),this.context.commandBinder.issueCommand(new BlurToolChangeCommand(e))},this.dismissTooltip=e=>{const t=Object.assign({},this.state.showTooltips);t[e]=!1,this.setState({showTooltips:t})};const{viewmodeData:t}=this.props.manager.dataMap;this.state={toolState:i.IDLE,brushState:a.DISABLED,viewmode:t.currentMode,brushSize:20,selectedBlur:null,showHints:!0,creating:!1,showTooltips:{[Ye.CREATE]:!0,[Ye.BRUSH_SIZE]:!0}}}componentDidMount(){const{blurEditorData:e,viewmodeData:t}=this.props.manager.dataMap;this.bindings.push(e.onPropertyChanged("toolState",this.onToolStateChange),e.onSelectedBlurChanged(this.onSelectedBlurChange),e.brush.onPropertyChanged(ze.scale,this.onBrushSizeChange),e.brush.onPropertyChanged(ze.state,this.onBrushStateChange),e.interactions.onPropertyChanged("createdBlur",(()=>{this.setState({showHints:!1})})),t.makeModeChangeSubscription((e=>{this.setState({viewmode:e})}))),this.onBrushSizeChange(e.brush.scale)}componentWillUnmount(){for(const e of this.bindings)e.cancel();this.bindings=[]}deleteSelectedBlur(){const{selectedBlur:e}=this.state,{commandBinder:t}=this.context;if(!e)throw new Error("Cannot delete, no Blur selected");t.issueCommand(new g.TL(e.id))}renderBrushControls(){const{brushSize:e,toolState:t}=this.state;return t!==i.PAINTING?null:(0,Te.jsxs)("div",Object.assign({className:"brush-controls"},{children:[this.renderBrushSizeTooltip(),(0,Te.jsx)("div",Object.assign({className:"brush-size-control"},{children:(0,Te.jsx)(ke.ZP,{min:1,max:100,step:1,included:!0,dots:!1,value:e,onChange:this.onBrushSizeSliderChange})}))]}))}renderOverlayMessage(){const{locale:e}=this.context,{toolState:t,showHints:s}=this.state;if(!s||t!==i.PAINTING)return null;const n=e.t((0,He.Jm)()?We.OVERLAY_MESSAGE_TOUCH:We.OVERLAY_MESSAGE);return(0,Te.jsxs)("div",Object.assign({className:"overlay-message"},{children:[(0,Te.jsx)("div",{className:"icon icon-brush-outline"}),(0,Te.jsx)("span",Object.assign({className:"message"},{children:n}))]}))}renderCreateTooltip(){const{showTooltips:e}=this.state;if(!e[Ye.CREATE])return null;const t=this.context.locale.t(We.CREATE_TOOLTIP_TITLE),s=this.context.locale.t(We.CREATE_TOOLTIP_MESSAGE);return(0,Te.jsx)(Fe.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(Ye.CREATE),message:(0,Te.jsx)("div",Object.assign({className:"message"},{children:s})),arrowPos:Fe.x.BOTTOM_CENTER})}renderBrushSizeTooltip(){const{showTooltips:e}=this.state;if(!e[Ye.BRUSH_SIZE])return null;const t=this.context.locale.t(We.BRUSH_TOOLTIP_TITLE),s=this.context.locale.t(We.BRUSH_TOOLTIP_MESSAGE);return(0,Te.jsx)(Fe.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(Ye.BRUSH_SIZE),message:(0,Te.jsx)("div",Object.assign({className:"message"},{children:s})),arrowPos:Fe.x.BOTTOM_CENTER})}render(){const{locale:e}=this.context,{brushState:t,toolState:s,selectedBlur:n,viewmode:r}=this.state,o=s===i.PAINTING&&n?"icon-checkmark":"icon-plus",l=Ve.BN.ENABLED,u=r===w.Ey.Panorama?Ve.BN.ENABLED:Ve.BN.DISABLED,d=Me()("overlay-cta-btn",{"overlay-cta-cancel":s===i.PAINTING&&!n}),c=Me()("overlay blur-tool-overlay",{painting:t===a.PAINTING}),h=s===i.SUGGESTING,m=n&&e.t(h?We.SUGGESTED_BLUR:We.DEFAULT_BLUR_NAME,{number:n.index});return(0,Te.jsxs)("div",Object.assign({className:c},{children:[n&&(0,Te.jsx)("div",Object.assign({className:"overlay-top-center"},{children:(0,Te.jsx)("div",Object.assign({className:"overlay-info"},{children:m}))})),!h&&(0,Te.jsxs)(Te.Fragment,{children:[this.renderOverlayMessage(),(0,Te.jsxs)(ActionBar,{children:[(0,Te.jsxs)("div",Object.assign({className:"overlay-cta"},{children:[this.renderCreateTooltip(),(0,Te.jsx)(je.hU,{className:d,iconClass:o,buttonStyle:je.Dd.PRIMARY,buttonState:u,onClick:this.onCreateClick}),n&&n.editable&&(0,Te.jsx)(je.hU,{className:"overlay-cta-button-outer",buttonStyle:je.Dd.OVERLAY,iconClass:"icon-delete",buttonState:l,onClick:this.onDeleteClick})]})),this.renderBrushControls()]})]})]}))}};$e.contextType=Ge.I,$e=Qe([Ue.Z],$e);var qe,Ze=s(73372),Ke=s(91354),Je=s(49384),Xe=s(29708),et=s(33057);!function(e){e.SCANS="scans",e.FLOORS="floors"}(qe||(qe={}));const{BLURS:tt}=me.Z.WORKSHOP,st=({value:e,onChange:t})=>{const s=(0,xe.b)(),i=[{text:s.t(tt.BLUR_STATUS_ALL),value:"all",selected:"all"===e},{text:s.t(tt.BLUR_STATUS_PENDING),value:f.Q.PENDING,selected:e===f.Q.PENDING},{text:s.t(tt.BLUR_STATUS_APPLIED),value:f.Q.APPLIED,selected:e===f.Q.APPLIED},{text:s.t(tt.BLUR_STATUS_FAILED),value:f.Q.FAILED,selected:e===f.Q.FAILED}];return(0,Te.jsx)(et.S,{className:"blur-filter blur-filter-status",menuStyle:et.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(tt.STATUS)})},it=({value:e,onChange:t})=>{const s=(0,xe.b)(),i=[{text:s.t(tt.GROUP_BY_SCAN),value:qe.SCANS,selected:e===qe.SCANS},{text:s.t(tt.GROUP_BY_FLOOR),value:qe.FLOORS,selected:e===qe.FLOORS}];return(0,Te.jsx)(et.S,{className:"blur-filter blur-filter-groupby",menuStyle:et.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(tt.GROUP_BY)})},nt=({value:e,onChange:t})=>{const s=(0,xe.b)(),i=[{text:s.t(tt.SORT_CREATED_DESC),value:"CREATED_DESC",selected:"CREATED_DESC"===e},{text:s.t(tt.SORT_CREATED_ASC),value:"CREATED_ASC",selected:"CREATED_ASC"===e}];return(0,Te.jsx)(et.S,{className:"blur-filter blur-filter-sort",menuStyle:et.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(tt.SORT)})};var at=s(19564),rt=s(22274),ot=s(72400),lt=s(45755);const ut=(0,lt.u)(BlurEditorData);function dt(){const[e,t]=(0,Ae.useState)(null),s=ut();return(0,Ae.useEffect)((()=>{const e=[];return s&&(e.push(s.onSelectedBlurChanged((e=>t(e)))),t(s.selectedBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}function ct(){const[e,t]=(0,Ae.useState)(null),s=ut();return(0,Ae.useEffect)((()=>{const e=[];return s&&(e.push(s.onHoveredBlurChanged((e=>t(e)))),t(s.hoveredBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}const{BLURS:ht}=me.Z.WORKSHOP;function mt({blur:e}){const{commandBinder:t}=(0,Ae.useContext)(Ge.I),s=ut(),i=dt(),n=ct(),a=(0,xe.b)(),r=(0,at.z)(),o=(0,Ae.useCallback)((()=>{t.issueCommand(new NavigateToBlurCommand(e,!0))}),[t,e]),l=(0,Ae.useCallback)((()=>{const s=e.visible;s?t.issueCommand(new HideBlursCommand(e.id)):t.issueCommand(new ShowBlursCommand(e.id)),r.trackToolGuiEvent("blur","blur_list_click_"+(s?"hide":"show"))}),[t,e,r]),u=(0,Ae.useCallback)((()=>{t.issueCommand(new g.TL(e.id)),r.trackToolGuiEvent("blur","blur_list_click_delete")}),[t,e,r]),d=(0,Ae.useCallback)((()=>{s&&(s.hoveredBlur=e)}),[e,s]),c=(0,Ae.useCallback)((()=>{s&&(s.hoveredBlur=null)}),[s]),h=e.status!==f.Q.PENDING,m=(0,Te.jsxs)("span",{children:[a.t(ht.DEFAULT_BLUR_NAME,{number:e.index}),h&&(0,Te.jsx)("span",Object.assign({className:"blur-status"},{children:e.status}))]}),p=e.status!==f.Q.APPLIED&&e.status!==f.Q.PROCESSING,b=(0,Te.jsxs)(Ie.hE,{children:[p&&(0,Te.jsx)(ot.Z,{id:e.id,visible:e.visible,showTooltip:ht.SHOW_LIST_ITEM_TOOLTIP_MESSAGE,hideTooltip:ht.HIDE_LIST_ITEM_TOOLTIP_MESSAGE,onClick:l}),(0,Te.jsx)(rt.n,{id:e.id,disabled:!e.editable,menu:[[ht.DELETE_BLUR_CTA,u]],closeOnMenuItemClick:!0,accordion:!0})]}),S=Me()("blur-list-item",{active:i&&i.id===e.id},{hover:n&&n.id===e.id});return(0,Te.jsx)(Ie.HC,{className:S,onClick:o,onMouseEnter:d,onMouseLeave:c,actions:b,title:m})}const gt="other",{BLURS:pt,SCANS:bt,VIEWS_360:ft}=me.Z.WORKSHOP;function St(e,t){const[s,i]=(0,Ae.useState)(qe.SCANS),[n,a]=(0,Ae.useState)([]),r=(0,xe.b)(),o=(0,Ae.useCallback)((()=>{const{sweepViewData:s}=t.dataMap,i=s.getAlignedSweeps(!1),n={};if(e){const t=e.groupBy("sweepId");for(const e in t){const a=s.getSweep(e);let o=r.t(bt.LIST_ITEM_TEXT,a.index+1);if(!a.isAligned()){const e=i.findIndex((e=>e.id===a.id))||0;o=a.name||r.t(ft.DEFAULT_NAME,{index:e+1})}n[e]={id:`sweep-${a.id}`,data:a,title:o,items:t[e]}}}return n}),[e,r,t.dataMap]),l=(0,Ae.useCallback)((()=>{const{floorsViewData:s}=t.dataMap,i={};if(e){const t=e.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,data:e,title:e.name,items:t[e.id]||[]}})),t.null&&(i.other={id:gt,title:r.t(pt.OTHER_GROUP_LABEL),items:t.null})}return i}),[e,r,t.dataMap]),u=(0,Ae.useCallback)((()=>{const e=s===qe.SCANS?o():l(),t=Object.values(e).sort(((e,t)=>e.title.localeCompare(t.title,void 0,{numeric:!0})));a(t)}),[o,l,s]);return(0,Ae.useEffect)((()=>{const t=[e.onChanged((()=>{u()}))];return u(),()=>{t.forEach((e=>e.cancel()))}}),[e,s,r,t.dataMap,u]),{groups:n,groupBy:s,setGroupBy:i}}const vt=(0,lt.u)(Ce.a);const{BLURS:Bt}=me.Z.WORKSHOP;let Ct=!1;const Et=()=>{const e=function(){const e=vt(),[t,s]=(0,Ae.useState)(0);return(0,Ae.useEffect)((()=>{if(!e)return()=>{};const t=()=>{s(e.getByAccepted(null).length)},i=e.onChanged(t);return t(),()=>i.cancel()}),[e]),t}(),{commandBinder:t}=(0,Ae.useContext)(Ge.I),s=(0,xe.b)(),n=(0,at.z)(),a=(0,Ae.useCallback)((()=>{n.trackToolGuiEvent("blur","blur_click_view_suggestions"),t.issueCommand(new BlurToolChangeCommand(i.SUGGESTING))}),[t,n]);if(!e)return null;const r=s.t(Bt.SUGGESTIONS_AVAILABLE_MESSAGE,e),o=(0,Te.jsxs)(Ie.zx,Object.assign({size:Ie.qE.SMALL,variant:Ie.Wu.SECONDARY,onClick:a},{children:[(0,Te.jsx)(Ie.o3,{}),(0,Te.jsx)("span",{children:s.t(Bt.VIEW_SUGGESTIONS)})]}));return Ct||(Ct=!0,n.trackToolGuiEvent("blur","blur_suggestions_banner_shown")),(0,Te.jsx)(Ie.jL,{layout:"horizontal",text:r,actions:o,className:"blur-list-banner"})};var wt=s(98062);const{BLURS:yt}=me.Z.WORKSHOP,Tt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,Te.jsx)(wt.u,{group:{name:s,id:t,items:i}})},xt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,Te.jsx)(Ie._m,{id:t,title:`${s} (${i.length})`})},It=({item:e})=>{const t=(0,xe.b)();if(!e){const e=t.t(yt.MULTI_FLOOR_EMPTY_MESSAGE);return(0,Te.jsx)(Ie.gQ,{message:e})}return(0,Te.jsx)(mt,{blur:e})},Dt=({className:e="",manager:t})=>{const{blurList:s}=t.dataMap,i=(0,xe.b)(),n=(0,at.z)(),[a,r]=(0,Ae.useState)(null),{groups:o,groupBy:l,setGroupBy:u}=St(s,t),d=(0,Ae.useCallback)((e=>{(0,Xe.p)(f.Q,e)?s.setFilter("status",(t=>t.status===e)):s.clearFilter("status"),null!==e&&n.trackToolGuiEvent("blur",`blur_list_filter_by_${e}`),r(e)}),[s,n]),[c,h]=(0,Ae.useState)(null),m=(0,Ae.useCallback)((e=>{switch(e){case"CREATED_DESC":s.sort(((e,t)=>e.created.getTime()-t.created.getTime()||e.index-t.index));break;case"CREATED_ASC":s.sort(((e,t)=>t.created.getTime()-e.created.getTime()||t.index-e.index))}null!==e&&n.trackToolGuiEvent("blur",`blur_list_sort_by_${e.toLowerCase()}`),h(e)}),[s,n]),g=(0,Ae.useCallback)((e=>{n.trackToolGuiEvent("blur",`blur_list_group_by_${e.toLowerCase()}`),u(e)}),[u,n]),p=Me()(e,"blur-list"),b=i.t(yt.NO_BLURS);return(0,Te.jsxs)("div",Object.assign({className:p},{children:[(0,Te.jsxs)("header",Object.assign({className:"blur-list-header"},{children:[(0,Te.jsx)(Et,{}),(0,Te.jsxs)(Ie.w0,{children:[(0,Te.jsx)(it,{value:l,onChange:g}),(0,Te.jsx)(st,{value:a,onChange:d}),(0,Te.jsx)(nt,{value:c,onChange:m})]})]})),(0,Te.jsx)("div",Object.assign({className:"blur-list-content"},{children:0===o.length?(0,Te.jsx)(Ie.gQ,{message:b,itemHeight:60}):(0,Te.jsx)(Ie.UQ,{data:o,itemHeight:60,renderItem:It,renderGroup:l===qe.FLOORS?Tt:xt})}))]}))};function _t(){const e=ut(),[t,s]=(0,Ae.useState)(i.OFF);return(0,Ae.useEffect)((()=>{const t=[];if(e){const i=()=>{s(e.toolState)};t.push(e.onPropertyChanged("toolState",i)),i()}return()=>{t.forEach((e=>e.cancel()))}}),[e]),t}const{BLURS:Rt}=me.Z.WORKSHOP,Pt=({suggestion:e,onResolved:t})=>{const{commandBinder:s}=(0,Ae.useContext)(Ge.I),i=(0,at.z)(),n=(0,xe.b)(),a=ut(),r=ct(),o=dt(),[l,u]=(0,Ae.useState)(null),d=(0,Ae.useCallback)((()=>{s.issueCommand(new Ee.rf(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept"),t(e,!0)}),[i,s,e,t]),c=(0,Ae.useCallback)((()=>{s.issueCommand(new Ee.oA(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject"),t(e,!1)}),[i,s,e,t]),h=(0,Ae.useCallback)((e=>{l||(u("accepted"),setTimeout(d,500),e.stopPropagation())}),[d,l]),m=(0,Ae.useCallback)((e=>{l||(u("rejected"),setTimeout(c,500),e.stopPropagation())}),[c,l]),g=(0,Ae.useCallback)((t=>{const n=e.visible;n?s.issueCommand(new Ee.mA(e.id)):s.issueCommand(new Ee.ee(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_"+(n?"hide":"show")),t.stopPropagation()}),[i,s,e]),p={placement:"top"},b=(0,Ae.useCallback)((()=>{a&&(a.hoveredBlur=e)}),[e,a]),f=(0,Ae.useCallback)((()=>{a&&(a.hoveredBlur=null)}),[a]),S=(0,Te.jsxs)(Ie.hE,{children:[(0,Te.jsx)(Ie.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:g,tooltip:e.visible?n.t(Rt.HIDE_LIST_ITEM_TOOLTIP_MESSAGE):n.t(Rt.SHOW_LIST_ITEM_TOOLTIP_MESSAGE),tooltipOptions:p}),(0,Te.jsx)(Ie.zx,{icon:"checkmark",onClick:h,tooltip:n.t(Rt.ACCEPT_SUGGESTION_TOOLTIP),tooltipOptions:p}),(0,Te.jsx)(Ie.zx,{icon:"close",onClick:m,tooltip:n.t(Rt.REJECT_SUGGESTION_TOOLTIP),tooltipOptions:p})]}),v=n.t(Rt.SUGGESTED_BLUR,{number:e.index}),B=Me()("blur-suggestion-list-item",{active:o&&o.id===e.id,hover:r&&r.id===e.id,accepted:"accepted"===l,rejected:"rejected"===l});return(0,Te.jsx)(Ie.HC,{actions:S,className:B,title:v,onClick:()=>{s.issueCommand(new NavigateToBlurCommand(e,!1))},onMouseEnter:b,onMouseLeave:f})},{BLURS:Ot}=me.Z.WORKSHOP,Nt=({onClose:e,manager:t})=>{const s=(0,xe.b)(),i=(0,at.z)(),{commandBinder:n}=(0,Ae.useContext)(Ge.I),{suggestionList:a}=t.dataMap,r=(0,Ae.useCallback)((()=>{n.issueCommand(new Ee.rf),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept_all"),e()}),[n,e,i]),o=(0,Ae.useCallback)((async()=>{await t.rejectAllSuggestions()&&(i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject_all"),e())}),[t,e,i]);if(!(null==a?void 0:a.length))return null;const l=a.length,u=s.t(Ot.SUGGESTIONS_FOUND_MESSAGE,l),d=(0,Te.jsxs)(Ie.hE,Object.assign({spacing:"small"},{children:[(0,Te.jsx)(Ie.zx,{variant:Ie.Wu.PRIMARY,size:Ie.qE.SMALL,onClick:r,label:s.t(Ot.ACCEPT_ALL_SUGGESTIONS)}),(0,Te.jsx)(Ie.zx,{variant:Ie.Wu.TERTIARY,size:Ie.qE.SMALL,onClick:o,label:s.t(Ot.REJECT_ALL_SUGGESTIONS)})]})),c=(0,Te.jsx)(Ie.zx,{size:Ie.qE.LARGE,variant:Ie.Wu.TERTIARY,onClick:e,className:"blur-banner-exit",icon:"back",label:s.t(Ot.CLOSE_SUGGESTIONS)});return(0,Te.jsx)("div",Object.assign({className:"suggestion-list-header"},{children:(0,Te.jsx)(Ie.jL,{text:u,actions:d,header:c})}))},{BLURS:At}=me.Z.WORKSHOP,kt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,Te.jsx)(Ie._m,{id:t,title:`${s} (${i.length})`})},Lt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,Te.jsx)(wt.u,{group:{name:s,id:t,items:i}})},Mt=({item:e,onResolved:t})=>{const s=(0,xe.b)();if(!e){const e=s.t(At.NO_SUGGESTIONS_ON_FLOOR);return(0,Te.jsx)(Ie.gQ,{message:e})}return(0,Te.jsx)(Pt,{suggestion:e,onResolved:t})},Gt=({className:e,manager:t,onClose:s})=>{const{suggestionList:i}=t.dataMap,n=(0,at.z)(),a=(0,xe.b)(),{groups:r,groupBy:o,setGroupBy:l}=St(i,t),u=(0,Ae.useCallback)((e=>{n.trackToolGuiEvent("blur",`blur_suggestion_list_group_by_${e.toLowerCase()}`),l(e)}),[n,l]),d=(0,Ae.useCallback)(((e,s)=>{t.debouncedNavigateToNextSuggestion(r,e)}),[t,r]);if(!i)return null;const c=Me()(e,"suggestion-list"),h=a.t(At.NO_SUGGESTIONS);return(0,Te.jsxs)("div",Object.assign({className:c},{children:[(0,Te.jsxs)("header",Object.assign({className:"suggestion-list-header"},{children:[(0,Te.jsx)(Nt,{manager:t,onClose:s}),(0,Te.jsx)(Ie.w0,{children:(0,Te.jsx)(it,{value:o,onChange:u})})]})),(0,Te.jsx)("div",Object.assign({className:"suggestion-list-content"},{children:0===r.length?(0,Te.jsx)(Ie.gQ,{message:h,itemHeight:42}):(0,Te.jsx)(Ie.UQ,{data:r,itemHeight:42,renderItem:Mt,renderItemProps:{onResolved:d},renderGroup:o===qe.FLOORS?Lt:kt})}))]}))},Ut=(0,lt.u)(b.f);const{BLURS:jt}=me.Z.WORKSHOP;function Vt(){const{analytics:e,commandBinder:t}=(0,Ae.useContext)(Ge.I),[s,n]=(0,Ae.useState)(!1),a=Ut(),r=(0,xe.b)(),o=function(){var e;const t=Ut(),[s,i]=(0,Ae.useState)((null===(e=null==t?void 0:t.getByStatus(f.Q.PROCESSING))||void 0===e?void 0:e.length)||0);return(0,Ae.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(f.Q.PROCESSING).length)}const s=t.makeProcessingSubscription(e);return e(),()=>s.cancel()}),[t]),s}(),l=function(){var e;const t=Ut(),[s,i]=(0,Ae.useState)((null===(e=null==t?void 0:t.getByStatus(f.Q.PENDING,f.Q.FAILED))||void 0===e?void 0:e.length)||0);return(0,Ae.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(f.Q.PENDING,f.Q.FAILED).length)}const s=[t.makeUnappliedSubscription(e),t.blurs.onElementChanged({onAdded:e,onRemoved:e})];return e(),()=>{s.forEach((e=>e.cancel()))}}),[t]),s}(),u=_t(),d=(0,Ae.useCallback)((async()=>{if(!a||0===l)return;n(!0),e.trackToolGuiEvent("blur","blur_click_apply");if(await Oe(a,t,!1))return t.issueCommand(new g.Mh).finally((()=>{n(!1)}));n(!1)}),[l,a,e,t]),c=o>0,h=l>0,m=u===i.PAINTING,p=h&&!c&&!s&&!m,b=c?r.t(jt.APPLYING,o):r.t(jt.APPLY_BLURS_CTA,l);return(0,Te.jsx)(Ie.zx,Object.assign({className:"apply-blurs-button",variant:Ie.Wu.TERTIARY,disabled:!p,size:Ie.qE.SMALL,onClick:d},{children:b}))}const{BLURS:Ft}=me.Z.WORKSHOP;function zt({manager:e,className:t}){const s=(0,Ke.m)(e.dataMap.blurList),n=(0,Ke.m)(e.dataMap.suggestionList),{commandBinder:a}=(0,Ae.useContext)(Ge.I),r=(0,xe.b)(),o=_t()===i.SUGGESTING,l=Me()(t,"blurs-panel"),u=(0,Ae.useCallback)((e=>{const t=o?i.IDLE:i.SUGGESTING;a.issueCommand(new BlurToolChangeCommand(t)),e&&e.stopPropagation()}),[o,a]),d=o?r.t(Ft.NUM_BLUR_SUGGESTIONS,n.length):r.t(Ft.NUM_TYPE,s.length),c=o?void 0:(0,Te.jsx)(Vt,{}),h=o?void 0:(0,Te.jsx)(Je.z,{toolId:D.w1.BLUR});return(0,Te.jsxs)(Ze.L,Object.assign({toolId:D.w1.BLUR,className:l,title:d,controls:c,subheader:h},{children:[o&&(0,Te.jsx)(Gt,{className:"blurs-panel-contents",manager:e,onClose:u}),!o&&(0,Te.jsx)(Dt,{className:"blurs-panel-contents",manager:e})]}))}class BlurToolUi{constructor(e,t){this.renderPanel=()=>(0,Te.jsx)(zt,{manager:this.manager}),this.renderActionBar=()=>(0,Te.jsx)($e,{manager:this.manager}),this.manager=e}}var Ht=s(34029),Qt=s(90632),Wt=s(45905),Yt=s(63252);class BlurEditorModule extends o.Y{constructor(){super(...arguments),this.name="blur_editor",this.activeBindings=[],this.setMeshCursorVisibility=()=>!this.data.hoveredBlur&&this.data.toolState!==i.PAINTING,this.changeToolState=async e=>{const t=this.data.toolState;e!==t&&(this.data.toolState=e,this.data.commit(),await this.onToolStateChange(e,t))},this.navigateToBlur=(e,t)=>{if(!e)throw new Error("Cannot navigate to non-existant blur");let s;const n=this.getFocalPoint(e.dots);if(n){const t=this.sweepData.getSweep(e.sweepId);n.applyQuaternion(t.rotation),s=(0,I.Z)((new r.Quaternion).setFromUnitVectors(x.f.FORWARD,n))}const a=new y.ju({transition:T.n.Interpolate,sweep:e.sweepId,rotation:s}),o=this.engine.commandBinder.issueCommand(a).then((()=>{this.data.selectedBlur=e||null}));return t&&this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE)),this.toolData.toolPanelLayout===D.wS.BOTTOM_PANEL&&this.engine.commandBinder.issueCommand(new _.Fg(!0)),o},this.onToolStateChange=async(e,t)=>{const{brush:s}=this.data;t===i.PAINTING&&await this.engine.commandBinder.issueCommand(new g.o8),e===i.PAINTING?(s.enable(),this.engine.broadcast(new R.ps(!1))):(s.disable(),this.engine.broadcast(new R.ps(!0))),e===i.OFF?(this.activeBindings.forEach((e=>e.cancel())),this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool=!1,this.data.interactions.commit(),this.renderer.setBlurs([])):this.activeBindings.forEach((e=>e.renew())),e!==i.OFF&&(this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool||(this.data.interactions.openedTool=!0,this.data.interactions.commit()),e===i.SUGGESTING?this.renderSuggestions():this.renderBlurs()),this.updatePolling()},this.checkForUpdates=()=>{let e;return(0,u.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.log.debug("Polling..."),this.engine.commandBinder.issueCommand(new g.s$)}),1e3*le.F8)}),(()=>{window.clearInterval(e)}),!1)},this.onViewmodeChange=e=>{const{toolState:t}=this.data;e!==w.Ey.Panorama&&t===i.PAINTING&&this.changeToolState(i.IDLE),e===w.Ey.Panorama?this.clickHandler.renew():this.clickHandler.cancel()},this.onSweepChange=e=>{const{selectedBlur:t}=this.data;t&&(this.onDeselectBlur(t),this.data.selectedBlur=null)},this.onBlursChanged=()=>{const{selectedBlur:e}=this.data;e&&!this.blurData.isEditable(e.id)&&(this.data.selectedBlur=null);const{toolState:t}=this.data;t!==i.SUGGESTING&&this.renderBlurs()},this.onSuggestionsChanged=()=>{const e=this.toolData.getTool(D.w1.BLUR);if(e){const t=this.suggestionData.getByAccepted(null).length>0;e.hasUpdates!==t&&(e.hasUpdates=t,e.commit())}if(!this.data)return;const{toolState:t}=this.data;t===i.SUGGESTING&&this.renderSuggestions()},this.onPointerButton=e=>{const{toolState:t}=this.data,{hit:s}=this.raycasterData;e.down&&t===i.PAINTING&&this.updateSelectedBlur(s?s.object:null)},this.onKeyEvent=e=>{const{selectedBlur:t}=this.data;if(t&&e.state===re.M.PRESSED)switch(e.key){case oe.R.ESCAPE:this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE));break;case oe.R.DELETE:this.data.selectedBlur&&this.engine.commandBinder.issueCommand(new g.TL(t.id))}},this.onClick=(e,t)=>{const{toolState:s}=this.data;return s===i.PAINTING||!!(t instanceof BlurMesh||this.data.selectedBlur)&&(this.updateSelectedBlur(t),!0)},this.onPaint=(e,t,s,i)=>{const n=this.sweepData.currentSweepObject;if(!n)return;let a=this.data.selectedBlur instanceof p.x?this.data.selectedBlur:null;const r=a?a.dotCount:0;(!a||r>le.Vw)&&(a=new p.x({sweepId:n.id}),n.placementType!==Yt.hU.UNPLACED&&(a.floorId=n.floorId,a.roomId=n.roomId),this.blurData.add(a),this.data.selectedBlur=a);const o=e.clone().applyQuaternion(n.rotation.clone().invert()).normalize();a.add(o,t,s,i)},this.updateHoveredBlur=()=>{const{toolState:e}=this.data,t=this.raycasterData.hit&&this.raycasterData.hit.object,s=e===i.PAINTING?null:this.getBlurFromMesh(t);if(s!==this.data.hoveredBlur&&(this.data.hoveredBlur=s,this.data.toolState!==i.PAINTING)){const e=s?B.C.FINGER:null;this.engine.commandBinder.issueCommand(new v.u(e))}}}async init(e,t){this.log.debug("Module config",e),this.engine=t,this.config=e,[this.blurData,this.cameraData,this.cursorController,this.raycasterData,this.settings,this.storageData,this.sweepData,this.toolData,this.viewmodeData]=await Promise.all([t.market.waitForData(b.f),t.market.waitForData(S.M_),t.getModuleBySymbol(l.y.CURSOR_CONTROLLER),t.market.waitForData(C.P),t.getModuleBySymbol(l.y.SETTINGS),t.market.waitForData(Qt.Q),t.market.waitForData(d.Z),t.market.waitForData(P.t),t.market.waitForData(E.O)]);const[s,n,a,o]=await Promise.all([t.getModuleBySymbol(l.y.INPUT),t.getModuleBySymbol(l.y.RENDER_TO_TEXTURE),t.market.waitForData(E.O),t.getModuleBySymbol(l.y.WEBGL_RENDERER)]);this.suggestionData=await t.market.waitForData(Ce.a),this.bindings.push(this.toolData.onChanged(this.onSuggestionsChanged),this.suggestionData.onChanged(this.onSuggestionsChanged));const u=(await t.getModuleBySymbol(l.y.SWEEP_PANO)).getRenderer();this.data=new BlurEditorData,t.market.register(this,BlurEditorData,this.data),this.cursorController.addVisibilityRule(this.setMeshCursorVisibility);const g=o.getScene();this.renderer=new BlurRenderer(this.sweepData,this.data,g,s,n,o.cwfRenderer,u),t.addComponent(this,this.renderer);const p=new PanoBrush(this.sweepData,this.cameraData,g,s);p.setSizeRange(le.oR,le.rC),p.onPaint=this.onPaint,t.addComponent(this,p),this.data.brush=p,this.registerSettings(),this.registerTool(),this.clickHandler=s.registerPriorityHandler(c.R,r.Mesh,this.onClick),this.bindings.push(t.commandBinder.addBinding(BlurToolChangeCommand,(async e=>this.changeToolState(e.state))),t.commandBinder.addBinding(SetBlurBrushScaleCommand,(async e=>this.data.brush.scale=e.scale)),t.commandBinder.addBinding(NavigateToBlurCommand,(async({blur:e,resetBlurTool:t})=>this.navigateToBlur(e,t))),t.commandBinder.addBinding(ShowBlursCommand,(({ids:e})=>this.showBlurs(...e))),t.commandBinder.addBinding(HideBlursCommand,(({ids:e})=>this.hideBlurs(...e))),t.commandBinder.addBinding(ToggleBlurVisibilityCommand,(async({id:e})=>this.batchToggleVisibility([e]))),t.commandBinder.addBinding(BatchToggleBlurVisibilityCommand,(async({ids:e})=>this.batchToggleVisibility(e)))),this.pollingSubscription=this.checkForUpdates(),this.updatePolling(),this.activeBindings.push(a.makeModeChangeSubscription(this.onViewmodeChange),this.sweepData.makeSweepChangeSubscription(this.onSweepChange),this.blurData.blurs.onChanged(this.onBlursChanged),s.registerHandler(h.er,this.onPointerButton),s.registerHandler(m.e,this.onKeyEvent),this.raycasterData.onChanged(this.updateHoveredBlur),this.clickHandler,this.storageData.onPropertyChanged("transactionState",(()=>this.updatePolling())),this.blurData.makeProcessingSubscription((()=>this.updatePolling()))),this.changeToolState(i.OFF),this.viewmodeData.currentMode&&this.onViewmodeChange(this.viewmodeData.currentMode),e.debug&&this.log.info("DEBUG mode enabled")}dispose(e){super.dispose(e),this.pollingSubscription&&this.pollingSubscription.cancel(),this.activeBindings.forEach((e=>e.cancel())),e.disposeRenderLayer(this.name),this.data&&e.market.unregister(this,BlurEditorData),this.cursorController.removeVisibilityRule(this.setMeshCursorVisibility)}renderBlurs(){const e=this.blurData.getByStatus(f.Q.PENDING,f.Q.PROCESSING,f.Q.FAILED).filter((e=>e.visible));this.renderer.setBlurs(e)}renderSuggestions(){const e=this.suggestionData.getByAccepted(!0,null).filter((e=>e.visible));this.renderer.setBlurs(e)}getFocalPoint(e){if(!e.length)return null;let t=0;const s=e.reduce(((e,s)=>{for(const i of s.directions)e.x+=i.x,e.y+=i.y,e.z+=i.z,t++;return e}),{x:0,y:0,z:0});return new r.Vector3(s.x/t,s.y/t,s.z/t)}async showBlurs(...e){this.blurData.setVisibility(!0,...e)}async hideBlurs(...e){this.blurData.setVisibility(!1,...e)}batchToggleVisibility(e){this.blurData.batchToggleVisibility(e)}updatePolling(){const{toolState:e}=this.data,{transactionState:t}=this.storageData,s=e!==i.OFF,n=t===Wt.g.IDLE;return s&&n?(this.pollingSubscription.renew(),this.log.debug("Polling enabled"),!0):(this.log.debug("Polling disabled"),this.pollingSubscription.cancel(),!1)}onDeselectBlur(e){const{toolState:t}=this.data;e&&t===i.PAINTING&&this.engine.commandBinder.issueCommand(new g.o8)}getBlurFromMesh(e){if(e&&e instanceof BlurMesh){const t=this.data.toolState===i.SUGGESTING,s=t?this.suggestionData.get(e.blurId):this.blurData.get(e.blurId);if(t||(null==s?void 0:s.status)===f.Q.PENDING)return s}return null}updateSelectedBlur(e){const t=this.getBlurFromMesh(e);t!==this.data.selectedBlur&&(this.onDeselectBlur(this.data.selectedBlur),this.data.selectedBlur=t,t&&this.log.debug(`Selected blur ${t.id}`))}registerSettings(){const e="Blur Tool",{brush:t}=this.data,{debug:s,meshBlurEnabled:i,pipelineEnabled:n}=this.config;[{header:e,setting:"blur/brush_size",range:[le.oR,le.rC],initialValue:()=>t.size,onChange:e=>t.size=e},{header:e,setting:"blur/brush_scale",range:[0,1],initialValue:()=>t.scale,onChange:e=>t.scale=e},{header:e,setting:"blur/tool_enabled",initialValue:()=>this.settings.tryGetProperty(le.x3,!1),onChange:e=>this.settings.updateSetting(le.x3,e)},{header:e,setting:"blur/mask",initialValue:()=>!1,onChange:e=>{this.renderer&&this.renderer.setMaskVisibility(e)}},{header:e,setting:"blur/show_cursor",initialValue:()=>!1,onChange:e=>{this.log.debug("Brush mouse cursor "+(e?"enabled":"disabled")),t.toggleMouseCursor(e)}},{header:e,setting:le.Vk,initialValue:()=>s,onChange:e=>{this.settings.updateSetting(le.Vk,e)}},{header:e,setting:$.pv,initialValue:()=>!1,onChange:e=>{this.settings.updateSetting($.pv,e)}},{header:e,setting:$.n5,initialValue:()=>n,onChange:e=>{this.settings.updateSetting($.n5,e)}},{header:e,setting:$.i7,initialValue:()=>i,onChange:e=>{this.settings.updateSetting($.i7,e)}}].forEach((e=>this.settings.registerMenuEntry(e)))}async registerTool(){const e=await this.engine.market.waitForData(Ht.e),t=new BlurToolManager(this.engine,e),s=new O.U({id:D.w1.BLUR,namePhraseKey:me.Z.TOOLS.BLUR,panel:!0,icon:"icon-blur-outline",analytic:"blur",palette:D.$r.MODEL_BASED,allViewsPhraseKey:me.Z.WORKSHOP.LAYERS.APPLY_TO_ALL_VIEWS_BLURS,order:90,dimmed:!1,enabled:e.tryGetProperty(le.x3,!1),manager:t,ui:new BlurToolUi(t,e),featureFlag:le.x3,helpMessagePhraseKey:me.Z.TOOLS.BLUR_HELP_MESSAGE,helpHref:"https://support.matterport.com/hc/en-us/articles/1500003156162-How-to-use-Manual-Blur-Brush"});this.engine.commandBinder.issueCommand(new _.MV([s]))}}},22645:(e,t,s)=>{"use strict";s.d(t,{a:()=>BlurSuggestionData});var i=s(67992),n=s(15637),a=s(39880);class BlurSuggestionData extends i.V{constructor(e){super(),this.name="blur-suggestion-data",this.suggestions=new n.v,e&&this.add(...e)}add(...e){this.suggestions.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.suggestions.has(t.id);)t.id=(0,a.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.suggestions.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.suggestions.set(t.id,t)})),this.commit()}has(e){return this.suggestions.has(e)}hasIndex(e){return!!this.suggestions.values.find((t=>t.index===e))}get(e){return this.suggestions.get(e)}getByAccepted(...e){return this.suggestions.values.filter((t=>e.includes(t.accepted)))}accept(...e){return this.updateAll(e,{accepted:!0})}reject(...e){return this.updateAll(e,{accepted:!1})}reset(...e){return this.updateAll(e,{accepted:null})}show(...e){return this.updateAll(e,{visible:!0})}hide(...e){return this.updateAll(e,{visible:!1})}updateAll(e,t){const s=e.length?e:this.suggestions.keys;this.atomic((()=>{this.suggestions.atomic((()=>{for(const e of s)if(this.has(e)){const s=this.get(e);Object.assign(s,t),s.commit()}})),this.commit()}))}}},91443:(e,t,s)=>{"use strict";s.d(t,{qY:()=>SaveSuggestionsCommand,ee:()=>ShowSuggestionsCommand,mA:()=>HideSuggestionsCommand,rf:()=>AcceptSuggestionsCommand,oA:()=>RejectSuggestionsCommand});var i=s(19663);class SaveSuggestionsCommand extends i.m{constructor(){super(...arguments),this.id="SAVE_BLUR_SUGGESTIONS"}}class ShowSuggestionsCommand extends i.m{constructor(...e){super(),this.id="SHOW_BLUR_SUGGESTIONS",this.payload={ids:e}}}class HideSuggestionsCommand extends i.m{constructor(...e){super(),this.id="HIDE_BLUR_SUGGESTIONS",this.payload={ids:e}}}class AcceptSuggestionsCommand extends i.m{constructor(...e){super(),this.id="ACCEPT_BLUR_SUGGESTIONS",this.payload={ids:e}}}class RejectSuggestionsCommand extends i.m{constructor(...e){super(),this.id="REJECT_BLUR_SUGGESTIONS",this.payload={ids:e}}}},15984:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BlurSuggestionData:()=>i.a,default:()=>BlurSuggestionsModule});var i=s(22645),n=s(97542),a=s(57956),r=s(2541),o=s(71954),l=s(64567),u=s(13117),d=s(98333),c=s(66222),h=s(79728),m=s(635);class HttpFileStore{constructor(e){this.config=e}async read(){const{url:e,deserializer:t,format:s,queue:i}=this.config;let n=await i.get(e);return"json"===s&&(n=JSON.parse(n)),t?t(n):n}}var g=s(53954),p=s(53261),b=s(62285),f=s(91443),S=s(3907),v=s(75287),B=s(39880);class BlurSuggestion extends v.T{constructor(e){super(),this.accepted=null,this.index=-1,this.classification=[],this.visible=!0,this.id=(0,B.O1)(11),e&&Object.assign(this,e)}}var C=s(73635),E=s(97998),w=s(9133);const y=new E.Z("blurSuggestionDeserializer");function T(e){const t=function(e){return function(t){const s=(0,C.LB)(null==t?void 0:t.dots),i=e.getSweepByUuid(null==t?void 0:t.sweepId);if(!(t&&s&&s.length&&i))return y.debug("Deserialized invalid Blur suggestion",t),null;const n=!0===t.accepted||!1===t.accepted?t.accepted:null;return new BlurSuggestion({id:t.sid,accepted:n,dots:s,index:t.index,floorId:i.floorId,roomId:i.roomId,sweepId:i.id,classification:t.tags||[],visible:!0,created:(0,w.p)(t.created),modified:(0,w.p)(t.modified)})}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}var x=s(50257);function I(e){const t=function(e){return function(t){const s=e.getSweep(t.sweepId),i=(0,x.o_)(t.dots);return s&&(null==i?void 0:i.length)?{sid:t.id,accepted:t.accepted,dots:i,index:t.index,sweepId:s.uuid,tags:t.classification,visible:t.visible,created:(0,w.U)(t.created),modified:(0,w.U)(t.modified)}:null}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}class BlurSuggestionStore extends S.MU{constructor(e){const{queue:t,baseUrl:s,modelId:i,sweepData:n}=e;super({queue:t,path:`${s}/api/v1/jsonstore/model/blur-suggestions/${i}`,batchUpdate:!0,deserialize:T(n),serialize:I(n)}),this.baseUrl=s,this.modelId=i}async read(){const e=await super.read();return Object.values(e||{})}async reset(){var e;const{queue:t}=this.config,s=`${this.baseUrl}/api/v1/jsonstore/model/blur-suggestions/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${s}`);if(window.confirm("Are you sure you want to reset all suggestions? This cannot be undone."))return t.delete(s,this.options).then((()=>{window.location.reload()}))}}function D(e){return t=>{const s=[];if(!(null==t?void 0:t.blurs))return[];const i=Object.values(t.blurs).filter((e=>!e.blurEnabled));for(const t of i){const i=e.getSweepByUuid(t.sweepId),n=(0,C.LB)(t.dots);if(!(null==n?void 0:n.length)||!i||!Array.isArray(null==t?void 0:t.dots))continue;const a=new BlurSuggestion({accepted:null,sweepId:i.id,dots:n,classification:["face"],floorId:i.floorId||void 0,visible:!0});s.push(a)}return s}}class BlurSuggestionsModule extends n.Y{constructor(){super(...arguments),this.name="blur-suggestions"}async init(e,t){this.engine=t,this.config=e,await this.load(),await this.registerSettings()}async load(){const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{market:o,commandBinder:d}=this.engine,[c,p]=await Promise.all([o.waitForData(u.f),o.waitForData(g.Z)]);this.blurData=c,this.store=new BlurSuggestionStore({queue:s,baseUrl:e,modelId:t,sweepData:p}),this.data=new i.a;const b=this.store.read();if(this.log.debug("Loaded existing suggestions",b),b&&b.then((async e=>{if(this.data)if(0===e.length){const e=await this.getSuggestionsFromVision();if(!this.data)return;this.data.add(...e),this.log.debug(`Importing ${e.length} suggestions from Vision...`),d.issueCommand(new f.qY)}else this.data.add(...e||[])})),!n){const e=await this.engine.getModuleBySymbol(a.y.STORAGE);this.bindings.push(d.addBinding(f.qY,(()=>d.issueCommand(new m.VQ({dataTypes:[h.g.BLUR_SUGGESTIONS]})))),d.addBinding(f.rf,(({ids:e})=>this.accept(...e))),d.addBinding(f.oA,(({ids:e})=>this.reject(...e))),d.addBinding(f.ee,(({ids:e})=>this.show(...e))),d.addBinding(f.mA,(({ids:e})=>this.hide(...e))),e.onSave((()=>this.save()),{dataType:h.g.BLUR_SUGGESTIONS}))}o.register(this,i.a,this.data),n||(this.monitor=new l.c(this.data.suggestions,{aggregationType:r.E.Manual}))}dispose(e){super.dispose(e),e.market.unregister(this,i.a),this.data=void 0}async accept(...e){const{commandBinder:t}=this.engine,s=e.length?e.map((e=>this.data.get(e))):this.data.getByAccepted(null),i=s.map((e=>d.x.from(e)));return this.blurData.add(...i),this.data.accept(...s.map((e=>e.id))),Promise.all([t.issueCommand(new c.o8),t.issueCommand(new f.qY)]).then((()=>{}))}async reject(...e){const{commandBinder:t}=this.engine,s=e.length?e:this.data.getByAccepted(null).map((e=>e.id));return this.data.reject(...s),t.issueCommand(new f.qY)}async show(...e){this.data.show(...e)}async hide(...e){this.data.hide(...e)}async save(){const{readonly:e}=this.config;if(e||!this.monitor)return;this.monitor.commitChanges();const t=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!t.length)return;const s={};for(const e of t)switch(e.action){case o.KI.added:case o.KI.updated:s[e.index]=this.data.get(e.index);break;case o.KI.removed:s[e.index]=null}return this.store.update(s).catch((e=>{this.log.error(e)}))}async getSuggestionsFromVision(){const{market:e}=this.engine,[t,s]=await Promise.all([e.waitForData(b.R),e.waitForData(g.Z)]);let i=null;const n=t.objectBlur;if(null==n?void 0:n.url){const e=new HttpFileStore({url:n.url,queue:this.config.queue||new p.gO,format:"json",deserializer:D(s)});i=await e.read()}return i||[]}async registerSettings(){const e=await this.engine.getModuleBySymbol(a.y.SETTINGS),{debug:t}=this.config;t&&e.registerMenuButton({header:"Blur Suggestions",buttonName:"Reset Suggestions",callback:()=>{this.store.reset()}})}}},62285:(e,t,s)=>{"use strict";s.d(t,{R:()=>VisionCatalogData});var i=s(67992);class VisionCatalogData extends i.V{constructor(e=[]){super(),this.catalog=e}get objectAnnotations(){return this.catalog.find((e=>"objectAnnotations"===e.name))}get semantic(){return this.catalog.find((e=>"semantic"===e.name))}get detectedObjects(){return this.catalog.find((e=>"detectedObjects"===e.name))}get objectBlur(){return this.catalog.find((e=>"objectBlur"===e.name))}}},47018:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>VisionCatalogModule});var i=s(97542),n=s(62285),a=s(5244),r=s(2942),o=s(17788),l=s(9133);class VisionCatalogStore extends o.u{async read(){return this._readAssets().then((e=>e.length?e:this._readCatalog()))}_readAssets(){const e={modelId:this.getViewId()};return this.query(a.GetVisionAssets,e).then((e=>{var t,s;const i=[],n=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.objectBlur;return(null==n?void 0:n.url)&&i.push({name:"objectBlur",contentType:n.contentType||"unknown",format:n.format,url:n.url,validUntil:(0,l.p)(n.validUntil)}),i}))}_readCatalog(){const e={modelId:this.getViewId()};return this.query(r.GetVisionCatalog,e).then((e=>{var t,s,i;const n=(null===(i=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.assets)||void 0===i?void 0:i.catalog)||[],a=[];return n.forEach((e=>{if(null==e?void 0:e.url){let t=e.type||"unknown";"unknown"===t&&e.url.match(/object\//i)&&(t="objectAnnotations"),"unknown"===t&&e.url.match(/blur/i)&&(t="objectBlur"),"unknown"===t&&e.url.match(/detected/i)&&(t="detectedObjects"),a.push({name:t,format:e.format,url:e.url,contentType:e.format,validUntil:(0,l.p)(e.validUntil)})}})),a}))}}class VisionCatalogModule extends i.Y{constructor(){super(...arguments),this.name="vision-catalog"}async init(e,t){const s=new VisionCatalogStore({readonly:!0,viewId:e.baseModelId}),i=await s.read().catch((e=>(this.log.info("Failed to load Vision Catalog"),[])));this.data=new n.R(i),t.market.register(this,n.R,this.data)}dispose(e){super.dispose(e),e.market.unregister(this,n.R)}}},98333:(e,t,s)=>{"use strict";s.d(t,{x:()=>Blur});var i=s(75287),n=s(39880),a=s(66310);class Blur extends i.T{constructor(e){super(),this.dots=[],this.status=a.Q.PENDING,this.floorId=null,this.roomId=null,this.visible=!0,this.created=new Date,this.modified=new Date,this.id=(0,n.O1)(11),this.index=-1,e&&Object.assign(this,e)}get editable(){return Blur.editableStatus.includes(this.status)}add(e,t,s,i){let n=this.dots.find((e=>e.radius===t&&e.feather===s&&e.strength===i));n||(n={radius:t,feather:s,strength:i,directions:[]},this.dots.push(n)),n.directions.push(e),this.modified.setTime(Date.now()),this.commit()}static from(e){return new Blur({status:a.Q.PENDING,dots:e.dots,sweepId:e.sweepId,floorId:e.floorId||null})}get dotCount(){return this.dots.reduce(((e,t)=>e+t.directions.length),0)}get sid(){return this.id}}Blur.editableStatus=[a.Q.FAILED,a.Q.PENDING]},13117:(e,t,s)=>{"use strict";s.d(t,{f:()=>BlurData});var i=s(67992),n=s(15637),a=s(37082),r=s(39880),o=s(97998),l=s(66310);new o.Z("BlurData");class BlurData extends i.V{constructor(e){super(),this.name="blur-data",this.blurs=new n.v,this._hasProcessing=new a.f(!1),this._hasUnapplied=new a.f(!1),e&&this.add(...Object.values(e))}add(...e){this.atomic((()=>{this.blurs.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.blurs.has(t.id);)t.id=(0,r.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.blurs.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.blurs.set(t.id,t)})),this.update(),this.commit()}))}delete(...e){return this.atomic((()=>{this.blurs.atomic((()=>{e.filter((e=>this.isEditable(e)&&this.blurs.delete(e)))})),this.update(),this.commit()})),e.length}get(e){return this.blurs.get(e)}getEditable(){return this.blurs.values.filter((e=>e.editable))}getBySweepId(e,t=null){return this.blurs.values.filter((s=>s.sweepId===e&&(null===t||s.visible===t)))}getByStatus(...e){return e.length?this.blurs.values.filter((t=>e.includes(t.status))):this.blurs.values}batchToggleVisibility(e){const t=e.some((e=>{const t=this.blurs.get(e);return!!t&&!t.visible}));for(const s of e){const e=this.blurs.get(s);e&&(e.visible=t,e.commit())}}has(e){return this.blurs.has(e)}hasIndex(e){return!!this.blurs.values.find((t=>t.index===e))}hasStatus(e){return this.blurs.values.some((t=>t.status===e))}hasUnappliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PENDING||e.status===l.Q.FAILED))}hasAppliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PROCESSING||e.status===l.Q.APPLIED||e.status===l.Q.FAILED))}hasProcessingBlurs(){return this.hasStatus(l.Q.PROCESSING)}setVisibility(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.visible=e,t.modified.setTime(Date.now()),t.commit()}})),this.commit()}))}setStatus(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.status=e,t.modified.setTime(Date.now()),t.commit()}})),this.update(),this.commit()}))}isEditable(e){if(!this.has(e))return!1;return this.get(e).editable}makeProcessingSubscription(e){return this._hasProcessing.onChanged(e)}makeUnappliedSubscription(e){return this._hasUnapplied.onChanged(e)}update(){let e=!1;const t=this.hasProcessingBlurs();t!==this._hasProcessing.value&&(this._hasProcessing.value=t,e=!0);const s=this.hasUnappliedBlurs();s!==this._hasUnapplied.value&&(this._hasUnapplied.value=s,e=!0),e&&this.commit()}onChanged(e){return super.onChanged(e)}}},66310:(e,t,s)=>{"use strict";var i;s.d(t,{Q:()=>i}),function(e){e.PENDING="pending",e.PROCESSING="processing",e.APPLIED="applied",e.FAILED="failed"}(i||(i={}))},66222:(e,t,s)=>{"use strict";s.d(t,{TL:()=>DeleteBlursCommand,o8:()=>SaveBlursCommand,ie:()=>PublishBlursCommand,s$:()=>RefreshBlursCommand,Mh:()=>ApplyBlursCommand});var i=s(19663);class DeleteBlursCommand extends i.m{constructor(...e){super(),this.id="DELETE_BLURS",this.payload={ids:e}}}class SaveBlursCommand extends i.m{constructor(){super(...arguments),this.id="SAVE_BLURS"}}class PublishBlursCommand extends i.m{constructor(){super(...arguments),this.id="PUBLISH_BLURS_COMMAND"}}class RefreshBlursCommand extends i.m{constructor(){super(...arguments),this.id="REFRESH_BLURS_COMMAND"}}class ApplyBlursCommand extends i.m{constructor(){super(...arguments),this.id="APPLY_BLURS_COMMAND"}}},81702:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ApplyBlursCommand:()=>i.Mh,Blur:()=>r.x,BlurData:()=>n.f,BlurStatus:()=>a.Q,DeleteBlursCommand:()=>i.TL,PublishBlursCommand:()=>i.ie,RefreshBlursCommand:()=>i.s$,SaveBlursCommand:()=>i.o8,default:()=>BlurDataModule});var i=s(66222),n=s(13117),a=s(66310),r=s(98333),o=s(97542),l=s(57956),u=s(2541),d=s(71954),c=s(64567),h=s(79728),m=s(635),g=s(53954),p=s(3907),b=s(39880),f=s(97998),S=s(36074),v=s(73635),B=s(50257);const C=new f.Z("BlurStore");class BlurStore extends p.MU{constructor(e){const{baseUrl:t,modelId:s,queue:i,sweepData:n}=e;super({queue:i,path:`${t}/api/v1/jsonstore/model/blurs/${s}`,batchUpdate:!0,deserialize:(0,v.B4)(n),serialize:(0,B.fM)(n)}),this.queue=i,this.baseUrl=t,this.modelId=s,this.serialize=(0,B.o2)(n)}async apply(e,{useChunks:t,meshBlurEnabled:s,pipelineEnabled:i}){if(!i)return void C.info("Pipeline disabled, no blurs will be applied to the model");const n={enableMeshBlur:s,levels:S.TW.map((e=>({size:e.size,sigmaRadians:.5*e.sigma/e.size})))},a={};for(const s of e){const e=t?s.sweepId:0,i=this.serialize(s);i&&(a[e]||(a[e]={}),a[e][s.id]=i)}const r=Object.keys(a).length,o=[];for(const e in a){const s=a[e];t&&C.debug(`Applying ${Object.values(s).length} blurs to Sweep ${e}`);const i=this.queue.post(`${this.baseUrl}/api/v2/pano-edit/${this.modelId}/blur-panos`,{withCredentials:!0,body:{blurs:s,options:n}});o.push(i),r>o.length&&(C.debug("waiting 100ms"),await(0,b.gw)(250))}return Promise.all(o)}}class BlurDataModule extends o.Y{constructor(){super(...arguments),this.name="blur_data",this.refreshPromise=null,this.saveBlurs=async()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new m.VQ({dataTypes:[h.g.BLURS]}))},this.onApplyBlursCommand=()=>this.applyBlurs()}async init(e,t){this.engine=t,this.config=e,await this.load(t)}dispose(e){super.dispose(e),e.market.unregister(this,n.f),this.data=void 0}async configureStorage(){if(this.store)return;const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{commandBinder:a,market:r}=this.engine,o=await r.waitForData(g.Z);this.store=new BlurStore({baseUrl:e,modelId:t,queue:s,sweepData:o}),n||(this.bindings.push(a.addBinding(i.s$,(()=>this.refresh())),a.addBinding(i.Mh,this.onApplyBlursCommand),a.addBinding(i.o8,this.saveBlurs),a.addBinding(i.TL,(async({ids:e})=>this.deleteById(...e)))),this.engine.getModuleBySymbol(l.y.STORAGE).then((e=>{this.bindings.push(e.onSave((()=>this.save()),{dataType:h.g.BLURS}))})))}async load(e){await this.configureStorage(),this.settings=await e.getModuleBySymbol(l.y.SETTINGS),this.data=new n.f,e.market.register(this,n.f,this.data);const t=await this.store.read();this.data.add(...Object.values(t||{})),this.monitor=new c.c(this.data.blurs,{aggregationType:u.E.Manual})}async refresh(){if(this.refreshPromise)return;if(!this.data.hasAppliedBlurs())return;const e=this.store.read().then((e=>{this.updateBlursFrom(...Object.values(e||{}))})).finally((()=>{this.refreshPromise=null}));return this.refreshPromise=e,e}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Blur changes will NOT be saved");await this.refresh(),this.monitor.commitChanges();const e=this.monitor.getDiffRecord().filter((({index:e,action:t})=>t===d.KI.removed||this.data.has(e)&&this.data.get(e).editable));if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case d.KI.added:case d.KI.updated:t[s.index]=this.data.get(s.index);break;case d.KI.removed:t[s.index]=null}return this.store.update(t)}async applyBlurs(){var e,t,s;if(this.data.hasProcessingBlurs())return;await this.save();const i=this.data.getByStatus(a.Q.PENDING,a.Q.FAILED);if(!i.length)return;i.length>S.Dr&&(this.log.info(`Applying Blurs: Truncating request to the maximum of ${S.Dr} Blurs. Total Pending: ${i.length}`),i.length=S.Dr),this.data.setStatus(a.Q.PROCESSING,...i.map((e=>e.id))),this.log.info(`Applying ${i.length} blurs...`);const n=null===(e=this.settings)||void 0===e?void 0:e.tryGetProperty(S.n5,!1),r=null===(t=this.settings)||void 0===t?void 0:t.tryGetProperty(S.i7,!1),o=null===(s=this.settings)||void 0===s?void 0:s.tryGetProperty(S.pv,!1);return this.store.apply(i,{useChunks:o,meshBlurEnabled:r,pipelineEnabled:n})}async deleteById(...e){if(this.data.delete(...e))return this.save()}updateBlursFrom(...e){this.data.atomic((()=>{e.forEach((e=>{if(this.data.has(e.id)){const t=this.data.get(e.id);e.status!==t.status&&(t.status=e.status,t.modified.setTime(e.modified.getTime()),t.commit())}}))}))}}},73635:(e,t,s)=>{"use strict";s.d(t,{B4:()=>h,LB:()=>m});var i=s(9133),n=s(97998),a=s(2569),r=s(98333),o=s(66310),l=s(36074),u=s(92542),d=s(63252);const c=new n.Z("blurDeserializer");function h(e){const t=function(e){return function(t){var s;const n=m(null==t?void 0:t.dots),a=e.getSweepByUuid(null===(s=null==t?void 0:t.sweepId)||void 0===s?void 0:s.replace(/-/g,""));if(!(t&&n&&n.length&&a))return c.debug("Deserialized invalid Blur",t),null;const u=new r.x({id:t.sid,index:"number"==typeof t.index?t.index:-1,status:t.status,sweepId:a.id,created:(0,i.p)(t.created)});return a.placementType!==d.hU.UNPLACED&&(u.floorId=a.floorId,u.roomId=a.roomId),n.forEach((e=>{e.directions.forEach((t=>{u.add(t,e.radius,e.feather,e.strength)}))})),u.modified=(0,i.p)(t.modified),u.status===o.Q.PROCESSING&&Date.now()-u.modified.getTime()>l.gJ&&(u.status=o.Q.FAILED),u}}(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[e.id]=e)}return s}}function m(e){if(!e||!Array.isArray(e))return null;const t=[];for(const s of e)if(g(s)){const e=s.unitVectors.map((e=>a.ep.fromVisionVector({x:"string"==typeof e.x?parseFloat(e.x):e.x,y:"string"==typeof e.y?parseFloat(e.y):e.y,z:"string"==typeof e.z?parseFloat(e.z):e.z})));t.push({directions:e,radius:(0,u.d)(s.radius),feather:"string"==typeof s.feather?parseFloat(s.feather):s.feather,strength:"string"==typeof s.strength?parseFloat(s.strength):s.strength})}return t}function g(e){return["unitVectors","radius","strength","feather"].every((t=>t in e))}},50257:(e,t,s)=>{"use strict";s.d(t,{o2:()=>o,fM:()=>l,o_:()=>u});var i=s(9133),n=s(2569),a=s(59296),r=s(92542);function o(e){return function(t){if(!t)return null;const s=e.getSweep(t.sweepId),n=u(t.dots);if(!s||!(null==n?void 0:n.length))return null;return{sid:t.id,index:t.index,sweepId:s.uuid,status:t.status,dots:n,visible:t.visible,created:(0,i.U)(t.created),modified:(0,i.U)(t.modified)}}}function l(e){const t=o(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[i.id]=e)}return s}}function u(e){if(!e)return null;return function(e,t=5){return e.map((e=>({unitVectors:e.unitVectors.map((e=>({x:(0,n.Zd)(e.x,t),y:(0,n.Zd)(e.y,t),z:(0,n.Zd)(e.z,t)}))),radius:(0,n.Zd)(e.radius,t),feather:(0,n.Zd)(e.feather,t),strength:(0,n.Zd)(e.strength,3)})))}(e.map((e=>({unitVectors:e.directions.map((e=>(0,a.m)(n.ep.toVisionVector(e)))),radius:(0,r.t)(e.radius),feather:e.feather,strength:e.strength}))))}},92542:(e,t,s)=>{"use strict";s.d(t,{t:()=>n,d:()=>a});var i=s(36074);function n(e){return Math.atan(e/i.U_)}function a(e){return i.U_*Math.tan(e)}},58611:(e,t,s)=>{"use strict";s.d(t,{M:()=>SetPanoOverlayCommand});var i=s(19663);class SetPanoOverlayCommand extends i.m{constructor(e,t,s){super(),this.id="SET_PANO_OVERLAY",this.payload={sweepId:e,texture:t,quaternion:s}}}},3907:(e,t,s)=>{"use strict";s.d(t,{MU:()=>JsonStoreStore});var i,n=s(39880),a=s(44584);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(i||(i={}));class ReadOnlyStore extends class Auth{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,a.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class JsonStoreStore extends ReadOnlyStore{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:s}=this.config,n=[],a=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const s of a){e[s]||t[s]||n.push(this.config.queue.delete(`${this.config.path}/${s}`,this.options))}const r=s(e,t),o=Object.assign(Object.assign({},this.options),{body:r});return n.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,o)),Promise.all(n)}updateInternal(e,t){const{serialize:s}=this.config,a=[],r=Object.assign({},this.options),o=Object.keys(e),l=Object.keys(t),u=(0,n.XN)(o.concat(l));for(const n in u){const o=u[n],l=e[o]||t[o];if(l){const e={};e[o]=l;const n={},u=t[o];u&&(n[o]=u);const d=s(e,n);r.body=d,a.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,r))}else a.push(this.config.queue.delete(`${this.config.path}/${o}`,this.options))}return Promise.all(a)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},65794:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform vec3 opacity;uniform vec3 radius;uniform vec3 feather;uniform vec3 color;varying vec4 vCenter;varying vec4 vPosition;void main(){float fragRadius=length(vPosition.xyz-vCenter.xyz);vec3 featherStart=radius-feather;vec3 circleAlphaWithFeather=1.-max(fragRadius-featherStart,0.)/(feather*2.);gl_FragColor=vec4(color.rgb*opacity*circleAlphaWithFeather,1.);}"},59285:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute mat4 instanceMatrix;varying vec4 vCenter;varying vec4 vPosition;void main(){vPosition=instanceMatrix*vec4(position,1.);vCenter=instanceMatrix*vec4(0.,0.,0.,1.);gl_Position=projectionMatrix*modelViewMatrix*vPosition;}"},34468:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;varying vec4 maskPosition;varying vec4 panoPosition;uniform samplerCube maskTexture;uniform samplerCube panoBlurredMap0;uniform samplerCube panoBlurredMap1;uniform samplerCube panoBlurredMap2;uniform samplerCube panoBlurredMap3;const vec4 SELECTED_OUTLINE_COLOR=vec4(1.,1.,1.,1.);const vec4 HOVER_COLOR=vec4(1.,1.,1.,1.);vec4 combineBlurs(vec4 mask,vec4 blurredColor0,vec4 blurredColor1,vec4 blurredColor2,vec4 blurredColor3){float maskAlpha=mask.r;float selectedAlpha=mask.g;float hoveredAlpha=mask.b;float targetSigma=maskAlpha*(4.*4.-1.);float blurRatio=log2(1.+targetSigma);float panoAlpha=max(1.-abs(blurRatio-0.)/1.,0.);float blurAlpha0=max(1.-abs(blurRatio-1.)/1.,0.);float blurAlpha1=max(1.-abs(blurRatio-2.)/1.,0.);float blurAlpha2=max(1.-abs(blurRatio-3.)/1.,0.);float blurAlpha3=max(1.-abs(blurRatio-4.)/1.,0.);float alpha=blurAlpha0+blurAlpha1+blurAlpha2+blurAlpha3;vec4 color=(panoAlpha*blurredColor0+blurAlpha0*blurredColor0+blurAlpha1*blurredColor1+blurAlpha2*blurredColor2+blurAlpha3*blurredColor3);color.a=alpha;float selectedMaskAlpha=smoothstep(0.65,0.75,selectedAlpha)*(1.-smoothstep(0.85,0.95,selectedAlpha));color=mix(color,SELECTED_OUTLINE_COLOR,selectedMaskAlpha);color=mix(color,HOVER_COLOR,hoveredAlpha*0.3);return color;}void main(){vec4 mask=textureCube(maskTexture,maskPosition.xyz);\n#ifdef DEBUG_BLUR_LEVELS\nmask=vec4(fract(gl_FragCoord.x/2048.),0.,0.,1.);\n#endif\nvec4 blurredColor0=textureCube(panoBlurredMap0,panoPosition.xyz);vec4 blurredColor1=textureCube(panoBlurredMap1,panoPosition.xyz);vec4 blurredColor2=textureCube(panoBlurredMap2,panoPosition.xyz);vec4 blurredColor3=textureCube(panoBlurredMap3,panoPosition.xyz);\n# ifdef DEBUG_BLUR_LEVELS\nif(gl_FragCoord.y>2000.){blurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);}\n#elif defined(DEBUG_BLUR_COLORS)\nblurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);\n#endif\ngl_FragColor=combineBlurs(mask,blurredColor0,blurredColor1,blurredColor2,blurredColor3);}"},77288:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec4 maskPosition;varying vec4 panoPosition;uniform mat4 maskMatrix;uniform mat4 panoMatrix1;uniform mat4 panoMatrix2;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.);maskPosition=maskMatrix*worldPosition;panoPosition=panoMatrix2*panoMatrix1*worldPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},5244:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionAssets"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",alias:{kind:"Name",value:"objectBlur"},name:{kind:"Name",value:"asset"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"blurs/suggestions",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"BlurSuggestionAsset"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"version"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:383}};t.loc.source={body:'# Fetches public output files from the Vision Catalog,\n# only available after platform 21.21.1 release\nquery GetVisionAssets($modelId: ID!) {\n  model(id: $modelId) {\n    objectBlur: asset(id: "blurs/suggestions") {\n      id\n      status\n      contentType\n      filename\n      format\n      url\n      validUntil\n      ... on BlurSuggestionAsset {\n          version\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionAssets=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionAssets")},2942:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionCatalog"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catalog"},arguments:[{kind:"Argument",name:{kind:"Name",value:"formats"},value:{kind:"ListValue",values:[{kind:"StringValue",value:"json",block:!1}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"description"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:290}};t.loc.source={body:'# Fetches Vision Catalog assets, restricted to staff users\nquery GetVisionCatalog($modelId: ID!) {\n  model(id: $modelId) {\n    assets {\n      catalog(formats: ["json"]) {\n        format\n        type\n        contentType\n        description\n        url\n        validUntil\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionCatalog=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionCatalog")}}]);